<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
</head>

<body>
    <h2>Tracking test</h2>
    <div>
        <div class="inputoutput">
            <video id='cam' width="700" height="500"></video>
        </div>
        <div class="inputoutput">
            <canvas id="canvasOutput"></canvas>
        </div>
    </div>
    <script>
        function onOpenCvReady() {
            cv['onRuntimeInitialized'] = () => {
                var image = document.getElementById('image');
                var video = document.getElementById('cam');
                video.style.display = 'none';
                //image.style.display = 'none';
                var canvas = document.getElementById("canvasOutput");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                var ctx = canvas.getContext('2d');
                // Get access to the camera!
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // Not adding `{ audio: true }` since we only want video now
                    const constraints = {
                        "video": {
                            "facingMode": {
                                "ideal": "user"
                            }
                        }
                    };
                    navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                        //video.src = window.URL.createObjectURL(stream);
                        video.srcObject = stream;
                        video.play();
                    });
                }

                // Video has been started/unpaused
                video.addEventListener('play', function () {
                    let cap = new cv.VideoCapture(video);
                    console.log(video, video.height, video.width);
                    let frame = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                    const FPS = 20;

                    function processVideo() {
                            let begin = Date.now();

                            // start processing.
                            cap.read(frame);
                            let mask = new cv.Mat();
                            let low = new cv.Mat(frame.rows, frame.cols, frame.type(), [180, 180, 180, 255]);
                            let high = new cv.Mat(frame.rows, frame.cols, frame.type(), [255, 255, 255, 255]);
                            cv.inRange(frame, low, high, mask);
                            low.delete(); high.delete();
                            //console.log('71 Processing time: ' + (Date.now() - begin) + 'ms');

                            let kernel = cv.Mat .ones(5, 5, cv.CV_8U);
                            let opening = new cv.Mat();
                            cv.morphologyEx(mask, opening, cv.MORPH_OPEN, kernel);
                            
                            // console.log('79 Processing time: ' + (Date.now() - begin) + 'ms');
                            let boundingRect = cv.boundingRect(opening)

                            let x = boundingRect.x;
                            let y = boundingRect.y;
                            let w = boundingRect.width;
                            let h = boundingRect.height;


                            let p1 = new cv.Point(0,0);
                            let p2 = new cv.Point(0,0);

                            if(x !== undefined && y !== undefined && w !== undefined && h !== undefined) {
                                p1 = new cv.Point(x, y);
                                p2 = new cv.Point(x + w, y + h);
                            }

                            cv.rectangle(frame, p1, p2, [0, 255, 0, 255], 2, cv.LINE_8, 0);

                            cv.imshow('canvasOutput', frame);

                            //console.log('85 Processing time: ' + (Date.now() - begin) + 'ms');

                            // Draw the rectangle

                            opening.delete(); kernel.delete(); mask.delete();
                            // schedule the next one.
                            let delay = 1000 / FPS - (Date.now() - begin);
                            setTimeout(processVideo, 1000 / FPS);
                    };

                    // schedule the first one.
                    setTimeout(processVideo, 0);

                })
            }
        };
    </script>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady()" type="text/javascript">
    </script>
</body>

</html>